name: CI-ARC-E2E-TEST

on:
  workflow_dispatch:
  
jobs:
  setup-kind:
    runs-on: [ubuntu-latest]
    steps:
      - uses: actions/checkout@v1
      - uses: actions/setup-go@v3
        with:
          go-version: 1.18
      - name: Install latest version of Kind
        run: go install sigs.k8s.io/kind
      - name: Create Kind cluster
        run: |
          PATH=$(go env GOPATH)/bin:$PATH
          kind create cluster --name e2e-test
  setup-arc:
    needs: setup-kind
    runs-on: [ubuntu-latest]
    steps:
      - uses: actions/checkout@v1
      - uses: AvaStancu/actions-workflows@v1
      - name: Cert manager setup
        run: |
          kubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.8.0/cert-manager.yaml
          kubectl -n cert-manager wait deploy/cert-manager-cainjector --for condition=available --timeout 90s
          kubectl -n cert-manager wait deploy/cert-manager-webhook --for condition=available --timeout 60s
          kubectl -n cert-manager wait deploy/cert-manager --for condition=available --timeout 60s
      - name: Create release
        run: kubectl create -f release/actions-runner-controller.yaml
      - name: Create secret generic controller-manager
        run: kubectl create secret generic controller-manager -n actions-runner-system --from-literal=github_token=${secrets.PERMISSION_TOKEN}
      - name: Create deployment
        run: kubectl apply -f runnerdeployment.yaml
  self-hosted-runner-job:
    needs: setup-arc
    strategy:
      fail-fast: false
      matrix:
        job: [1, 2, 3]
    runs-on: example-auto-scale-runner-set
    steps:
      - run: |
         printenv|sort
         # echo "Hello World!" >> $GITHUB_STEP_SUMMARY


